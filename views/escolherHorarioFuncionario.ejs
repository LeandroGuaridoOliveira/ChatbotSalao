<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Escolher Horário</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
</head>
<body>

<h1>Escolha um Horário</h1>

<form id="formAgendamento" method="post" action="/confirmarAgendamento">
  <input type="hidden" id="horario" name="horario">
  <input type="hidden" id="dia" name="dia" value="<%= dia %>">
  <input type="hidden" id="fimExpediente" value="<%= fimExpediente %>">

  <h3>Procedimentos:</h3>
  <% procedimentos.forEach(proc => { %>
    <div>
      <input 
        type="checkbox" 
        name="procedimentos" 
        value="<%= proc.id %>" 
        data-duracao="<%= proc.duracao %>">
      <%= proc.nome %> (<%= proc.duracao %> min)
    </div>
  <% }) %>

  <h3>Horários Disponíveis:</h3>
  <% horarios.forEach(h => { %>
    <button type="button" onclick="escolherHorario('<%= h %>')" style="margin:5px;"><%= h %></button>
  <% }) %>
</form>

<script>
async function escolherHorario(horario) {
  const procedimentosSelecionados = [...document.querySelectorAll('input[name="procedimentos"]:checked')];
  
  if (procedimentosSelecionados.length === 0) {
    Swal.fire('Atenção', 'Selecione ao menos um procedimento.', 'warning');
    return;
  }

  const procedimentos = procedimentosSelecionados.map(p => ({
    id: p.value,
    duracao: parseInt(p.dataset.duracao)
  }));

  // Calcular duração total + descanso
  const duracaoTotal = procedimentos.reduce((total, p) => total + p.duracao, 0) + 10; // 10 minutos só uma vez

  const horaInicio = dayjs(`${document.getElementById('dia').value}T${horario}`);
  const horaFimEsperada = horaInicio.add(duracaoTotal, 'minute');

  const expedienteFim = dayjs(`${document.getElementById('dia').value}T${document.getElementById('fimExpediente').value}`);

  if (horaFimEsperada.isAfter(expedienteFim)) {
    Swal.fire('Erro', 'O horário escolhido não comporta todos os procedimentos selecionados.', 'error');
    return;
  }

  // Se der tudo certo
  document.getElementById('horario').value = horario;
  document.getElementById('formAgendamento').submit();
}
</script>

</body>
</html>
